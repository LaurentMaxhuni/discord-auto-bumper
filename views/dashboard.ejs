<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Discord Bump Dashboard</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <header>
    <h1>Discord Bump Dashboard</h1>
    <div class="user">Logged in as <strong><%= user.username %></strong> | <a href="/logout">Logout</a></div>
  </header>

  <main>
    <section class="card">
      <h2>Pick a server</h2>
      <div id="guilds" class="grid"></div>
    </section>

    <section class="card" id="config-section" hidden>
      <h2 id="guildTitle">Configure</h2>
      <label>Channel
        <select id="channels"></select>
      </label>
      <label>Interval (minutes)
        <input id="interval" type="number" min="1" value="120">
      </label>
      <label>Message
        <input id="message" type="text" maxlength="2000" value="Bumped! üöÄ">
      </label>
      <div class="row">
        <button id="saveBtn">Save</button>
        <button id="removeBtn" class="danger">Remove Schedule</button>
      </div>
      <div id="status"></div>
    </section>
  </main>

  <script>
    const guildsEl = document.getElementById('guilds');
    const configSection = document.getElementById('config-section');
    const guildTitle = document.getElementById('guildTitle');
    const channelsEl = document.getElementById('channels');
    const intervalEl = document.getElementById('interval');
    const messageEl = document.getElementById('message');
    const saveBtn = document.getElementById('saveBtn');
    const removeBtn = document.getElementById('removeBtn');
    const statusEl = document.getElementById('status');
    let selectedGuild = null;

    async function loadGuilds() {
      const r = await fetch('/api/guilds');
      const data = await r.json();
      guildsEl.innerHTML = '';
      data.guilds.forEach(g => {
        const div = document.createElement('div');
        div.className = 'guild';
        div.innerHTML = '<span>' + (g.name || g.id) + '</span>';
        div.onclick = () => selectGuild(g, data.config[g.id]);
        guildsEl.appendChild(div);
      });
    }

    async function selectGuild(g, cfg) {
      selectedGuild = g;
      guildTitle.textContent = 'Configure: ' + (g.name || g.id);
      configSection.hidden = false;
      statusEl.textContent = '';

      const rc = await fetch('/api/channels?guild_id=' + g.id);
      const data = await rc.json();
      channelsEl.innerHTML = '';
      data.channels.forEach(ch => {
        const opt = document.createElement('option');
        opt.value = ch.id;
        opt.textContent = ch.name;
        channelsEl.appendChild(opt);
      });

      if (cfg) {
        channelsEl.value = cfg.channelId;
        intervalEl.value = cfg.intervalMinutes || 120;
        messageEl.value = cfg.message || 'Bumped! üöÄ';
      }
    }

    saveBtn.onclick = async () => {
      if (!selectedGuild) return;
      const body = {
        guildId: selectedGuild.id,
        channelId: channelsEl.value,
        intervalMinutes: Number(intervalEl.value) || 120,
        message: messageEl.value
      };
      const r = await fetch('/api/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      const data = await r.json();
      statusEl.textContent = data.ok ? 'Saved ‚úÖ' : 'Failed ‚ùå';
    };

    removeBtn.onclick = async () => {
      if (!selectedGuild) return;
      const r = await fetch('/api/remove', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ guildId: selectedGuild.id }) });
      const data = await r.json();
      statusEl.textContent = data.ok ? 'Removed ‚úÖ' : 'Failed ‚ùå';
    };

    loadGuilds();
  </script>
</body>
</html>
